name: Build AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build with PyInstaller
      run: |
        pyinstaller --clean \
          --onefile \
          --name RommSync \
          --add-data "app/static:app/static" \
          --hidden-import uvicorn.logging \
          --hidden-import uvicorn.loops.auto \
          --hidden-import uvicorn.protocols.http.auto \
          --hidden-import uvicorn.protocols.websockets.auto \
          --hidden-import uvicorn.lifespan.on \
          app/main.py
          
    - name: Install AppImage tools
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse libfuse2
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
    - name: Create AppDir structure
      run: |
        mkdir -p RommSync.AppDir/usr/bin
        cp dist/RommSync RommSync.AppDir/usr/bin/
        cp config.example.yaml RommSync.AppDir/usr/bin/config.yaml
        
        # Create desktop file
        cat > RommSync.AppDir/RommSync.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=RommSync
        Exec=RommSync
        Icon=rommsync
        Categories=Utility;Game;
        Terminal=false
        EOF
        
        # Create icon
        cat > RommSync.AppDir/rommsync.svg << 'EOF'
        <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#bb66ff;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#44ccff;stop-opacity:1" />
            </linearGradient>
          </defs>
          <rect width="256" height="256" fill="url(#grad)" rx="32"/>
          <text x="128" y="160" font-size="100" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-weight="bold">RS</text>
        </svg>
        EOF
        
        # Create AppRun
        cat > RommSync.AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        cd "${HERE}/usr/bin"
        exec "${HERE}/usr/bin/RommSync" "$@"
        EOF
        chmod +x RommSync.AppDir/AppRun
        
    - name: Build AppImage
      run: |
        # Extract appimagetool
        ./appimagetool-x86_64.AppImage --appimage-extract
        # Use extracted version with architecture specified
        ARCH=x86_64 ./squashfs-root/AppRun RommSync.AppDir RommSync-x86_64.AppImage
        chmod +x RommSync-x86_64.AppImage
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: RommSync-x86_64.AppImage
        body: |
          ## RommSync - ROM Sync Tool for RetroDeck
          
          Download the AppImage below and run on your Steam Deck!
          
          ### Installation:
          1. Download `RommSync-x86_64.AppImage`
          2. Copy to Steam Deck
          3. Make executable: `chmod +x RommSync-x86_64.AppImage`
          4. Edit `config.yaml` with your ROMM server details
          5. Run: `./RommSync-x86_64.AppImage`
          6. Open browser to http://localhost:5000
          
          ### Features:
          - Browse ROMM library from Steam Deck
          - Selective ROM downloads
          - Beautiful UI with RetroDeck theme
          - Platform mappings via Settings page
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifact (for workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: RommSync-AppImage
        path: RommSync-x86_64.AppImage
